<div class="profile-container">

    <section class="profile-card">

        <div class="cover-image-wrapper">
            <img src="./assets/images/3.jpg" alt="Cover Image" class="cover-image">
        </div>

        <div class="profile-info-section">

            <div class="profile-picture-wrapper">
                <img [src]="fileUtilsService.getImageUrl(profileData?.imageProfilePath)"
                    alt="Profile Picture" class="profile-image">
                <span class="active-dot"></span>
            </div>

            <div class="user-details">
                <h2>{{ profileData?.name }}</h2>
                <div class="contact-details">
                    <span *ngIf="profileData?.city && profileData?.country" class="location">
                        <mat-icon>location_on</mat-icon>
                        {{ profileData?.city }}, {{ profileData?.country }}
                    </span>
                    <span *ngIf="profileData?.email" class="website">
                        <mat-icon>email</mat-icon>
                        <a [href]="profileData?.email" target="_blank">{{ profileData?.email }}</a>
                    </span>
                </div>
                <div *ngIf="profileData" class="user-rating-container">
    <span class="rating-value">{{ userRating | number: '1.1-1' }}</span>
    
    <div class="stars">
        <mat-icon 
            *ngFor="let starType of getStarArray()" 
            class="star-icon"
            [ngClass]="{'filled': starType !== 'star_border'}">
            {{ starType }}
        </mat-icon>
    </div>
</div>
                
                <ng-container *ngIf="isTeacher && profileData?.teacher as teacherDetails">
                    <hr> <div class="teacher-info-quick-view">
                        <p *ngIf="teacherDetails.experience">
                            <mat-icon>trending_up</mat-icon>
                            <strong>× ×™×¡×™×•×Ÿ:</strong> {{ teacherDetails.experience }} ×©× ×™×
                        </p>
                        <p *ngIf="teacherDetails.lessonDuration">
                            <mat-icon>schedule</mat-icon>
                            <strong>××©×š ×©×™×¢×•×¨:</strong> {{ teacherDetails.lessonDuration }} ×“×§×•×ª
                        </p>
                        <p *ngIf="teacherDetails.pricePerLesson">
                            <mat-icon>paid</mat-icon>
                            <strong>××—×™×¨ ×œ×©×™×¢×•×¨:</strong> â‚ª{{ teacherDetails.pricePerLesson }}
                        </p>
                        <p *ngIf="instrumentsString">
                            <mat-icon>piano</mat-icon>
                            <strong>××œ××“/×ª:</strong> {{ instrumentsString }}
                        </p>
                    </div>
                </ng-container>
                </div>

            <div class="action-buttons" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">

                <ng-container *ngIf="profileData && isCurrentUserProfile; else notCurrentUser">
                    <button class="edit-btn" (click)="openEditProfileModal()">
                        <mat-icon>edit</mat-icon>
                        ×¢×¨×•×š ×¤×¨×•×¤×™×œ
                    </button>

                    
                    <button
                        *ngIf="!isTeacher"
                        class="teacher-signup-btn"
                        (click)="checkTeacherEligibility()">
                        <mat-icon>school</mat-icon>
                        ×”×¤×•×š ×œ××•×¨×”
                    </button>
                    <button class="signout-btn" (click)="handleSignOut()">
                        <mat-icon>logout</mat-icon>
                        ×”×ª× ×ª×§
                    </button>
                </ng-container>


                <ng-template #notCurrentUser>
                    <div class="profile-actions-container">

                        <button
                            mat-raised-button
                            color="accent"
                            (click)="followUser()"
                            class="action-button follow-button"
                        >
                            <mat-icon>{{ isFollowing ? 'person_remove' : 'person_add' }}</mat-icon>
                            {{ isFollowing ? ' Stop Follow' : 'Follow' }}
                        </button>

                        <ng-container *ngIf="canBeStudent">
                            <button
                                mat-raised-button
                                color="primary"
                                (click)="joinAsStudent()"
                                [disabled]="isStudentOfThisTeacher"
                                class="action-button student-button"
                            >
                                <mat-icon>{{ isStudentOfThisTeacher ? 'check_circle' : 'school' }}</mat-icon>
                                {{ isStudentOfThisTeacher ? 'Student Assigned' : 'Join as Student' }}
                            </button>
                        </ng-container>
                        <ng-container *ngIf="isElevatedAdmin && profileData && profileId">
            <button
                mat-raised-button
                color="warn"
                (click)="deleteUser()"
                class="action-button delete-button"
                title="××—×§ ×œ×¦××™×ª×•×ª ××ª ×”××©×ª××© ×”×–×”"
            >
                <mat-icon>delete_forever</mat-icon>
                ××—×§ ××©×ª××©
            </button>
        </ng-container>
                        <ng-container *ngIf="showAdminActions">
                            <div class="admin-actions-dropdown">
                                <button mat-icon-button [matMenuTriggerFor]="adminMenu">
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                            </div>
                        </ng-container>

                    </div>
                </ng-template>

                <mat-menu #adminMenu="matMenu">
                    <button mat-menu-item (click)="assignAdminRole()">
                        <mat-icon>admin_panel_settings</mat-icon>
                        <span>Make Admin</span>
                    </button>

                    <button mat-menu-item (click)="assignSuperAdminRole()">
                        <mat-icon>verified_user</mat-icon>
                        <span>Make Super Admin</span>
                    </button>
                </mat-menu>

            </div>

        </div>

    </section>

</div>

<div class="profile-description" *ngIf="profileData?.description || profileData?.teacher">

    <div class="role-section" *ngIf="profileData?.teacher">
        ğŸ‘¨â€ğŸ« ××•×¨×” ×œ××•×–×™×§×”
    </div>

    <p class="description-text" *ngIf="profileData?.description">
        {{ profileData?.description }}
    </p>

</div>

<div class="profile-tabs">
    <button [class.active]="activeTab==='overview'" (click)="setActiveTab('overview')">
        <i class="material-icons">person_outline</i> ×¡×§×™×¨×” ×›×œ×œ×™×ª
    </button>

    <button [class.active]="activeTab==='tracks'" (click)="setActiveTab('tracks')">
        <i class="material-icons">music_note</i> Tracks ({{ tracks?.length || 0 }})
    </button>

    <button [class.active]="activeTab==='movies'" (click)="setActiveTab('movies')">
        <i class="material-icons">videocam</i> Video ({{ videos?.length || 0 }})
    </button>

    <button [class.active]="activeTab==='sheets'" (click)="setActiveTab('sheets')">
        <i class="material-icons">description</i> Sheets ({{ sheets?.length || 0 }})
    </button>

    <button [class.active]="activeTab==='posts'" (click)="setActiveTab('posts')">
        <i class="material-icons">chat_bubble_outline</i> Posts ({{ posts?.length || 0 }})
    </button>
</div>

<div class="tab-content">

    <div *ngIf="activeTab === 'overview'" class="overview-content">
        <h3>××•×“×•×ª {{ profileData?.name }}</h3>
        <p>{{ profileData?.description || '×”××©×ª××© ×œ× ×”×•×¡×™×£ ×ª×™××•×¨ ×¢×“×™×™×Ÿ.' }}</p>

        <ng-container *ngIf="isTeacher && profileData?.teacher as teacherDetails">
            <div class="teacher-details">
                <h4>×¤×¨×˜×™ ×”×•×¨××” ğŸ¶</h4>
                <ul class="teacher-info-list">

                    <li *ngIf="teacherDetails.experience">
                        <mat-icon>trending_up</mat-icon>
                        <strong>× ×™×¡×™×•×Ÿ:</strong>
                        {{ teacherDetails.experience }} ×©× ×™×
                    </li>

                    <li *ngIf="teacherDetails.lessonDuration">
                        <mat-icon>schedule</mat-icon>
                        <strong>××©×š ×©×™×¢×•×¨:</strong>
                        {{ teacherDetails.lessonDuration }} ×“×§×•×ª
                    </li>

                    <li *ngIf="teacherDetails.pricePerLesson">
                        <mat-icon>paid</mat-icon>
                        <strong>××—×™×¨ ×œ×©×™×¢×•×¨:</strong>
                        â‚ª{{ teacherDetails.pricePerLesson }}
                    </li>

                    <li *ngIf="instrumentsString">
                        <mat-icon>piano</mat-icon>
                        <strong>××œ××“/×ª:</strong>
                        {{ instrumentsString }}
                    </li>
                </ul>
            </div>
        </ng-container>
    </div>
    <div *ngIf="activeTab === 'posts'">
        <app-posts [postsFromProfile]="posts ?? []" [isProfileView]="true"></app-posts>
    </div>

    <div *ngIf="activeTab === 'tracks'">
        <app-posts [postsFromProfile]="tracks ?? []" [showOnlyMedia]="'audio'" [isProfileView]="true"></app-posts>
    </div>

    <div *ngIf="activeTab === 'movies'">
        <app-posts [postsFromProfile]="videos ?? []" [showOnlyMedia]="'video'" [isProfileView]="true"></app-posts>
    </div>

    <div *ngIf="activeTab === 'sheets'">
        <app-sheets-music
            [sheets]="sheets ?? []"
            [isProfileView]="true"
        ></app-sheets-music>
    </div>

</div>